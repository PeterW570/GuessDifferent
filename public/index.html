<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Guess Different</title>
	<style>
		*,
		*::before,
		*::after {
			position: relative;
			box-sizing: border-box;
		}

		@keyframes spinner {
			0% {
				transform: translate3d(-50%, -50%, 0) rotate(0deg);
			}

			100% {
				transform: translate3d(-50%, -50%, 0) rotate(360deg);
			}
		}

		.loading>* {
			visibility: hidden
		}

		.loading::after {
			animation: 1.5s linear infinite spinner;
			animation-play-state: inherit;
			border: solid 5px #cfd0d1;
			border-bottom-color: #1c87c9;
			border-radius: 50%;
			content: "";
			height: 40px;
			width: 40px;
			position: absolute;
			top: 10px;
			left: 20px;
			transform: translate3d(-50%, -50%, 0);
			will-change: transform;
		}

		.player.me {
			color: blue;
		}
	</style>
</head>

<body>
	<guess-different></guess-different>

	<script type="module">
		import UTILS from './scripts/utils.js';
		let playerName = null;

		class BaseView extends HTMLElement {
			showSpinner() {
				UTILS.$.addClass(this, 'loading');
				return {
					hide: () => UTILS.$.removeClass(this, 'loading'),
				}
			}
		}

		class App extends BaseView {
			connectedCallback() {
				this.innerHTML = `
					<h1>Guess Different</h1>
					<choose-name></choose-name>
					<players-view></players-view>
				`
				const spinner = this.showSpinner();
				UTILS.WS.connect(() => spinner.hide());

				UTILS.WS.addSub(({ message: { question, possibleAnswers } }) => {
					UTILS.$.appendHTML(this, `<question-view></question-view>`);
					this.querySelector('question-view').setQuestion({ question, possibleAnswers });
				}, { key: 'new:question' })
			}
		}

		class QuestionComponent extends BaseView {
			setQuestion({ question, possibleAnswers }) {
				this.innerHTML = `
				<div>${question}</div>
				${possibleAnswers.map(ans => `<input type="radio" id="${ans}" name="question" value="${ans}" /><label for="${ans}">${ans}</label>`)}
				`

				setTimeout(() => {
					const answer = this.querySelector('input[name="question"]:checked').value;
					UTILS.WS.send({ key: 'check:answer', message: answer });
					this.remove();
				}, 1000 * 20);
			}
		}

		class ChooseNameComponent extends BaseView {
			connectedCallback() {
				this.innerHTML = `<form>
					<input name="name" placeholder="Name" />
					<button type="submit">Submit</button>
				</form>`;
				this.boundOnSubmitForm = this.onSubmitForm.bind(this);
				this.querySelector('form').addEventListener('submit', this.boundOnSubmitForm);
			}

			disconnectedCallback() {
				this.querySelector('form').removeEventListener('submit', this.boundOnSubmitForm);
			}

			onSubmitForm(e) {
				e.preventDefault();
				const name = this.querySelector('input').value;
				const spinner = this.showSpinner();
				UTILS.WS.addSub(({ message }) => {
					if (message !== 'OK') console.error('error setting name'); // TODO: handle
					playerName = name;
					spinner.hide();
					this.remove();
				}, { key: 'set:name', once: true });
				UTILS.WS.send({ key: 'set:name', message: name });
			}
		}

		class PlayersComponent extends BaseView {
			connectedCallback() {
				this.innerHTML = `<div class="players-container"></div>`;
				this.$container = this.querySelector('.players-container');

				UTILS.WS.addSub(({ key, message: allData }) => {
					// TODO: just update rather than empty + add
					UTILS.$.empty(this.$container);
					allData.forEach(d => this.addPlayer(d));
				}, { key: 'all-players' });
				UTILS.WS.send({ key: 'get:players' });
			}
			addPlayer({ name = 'Anon', score = 0 }) {
				if (name === playerName) UTILS.$.appendHTML(this.$container, `<div class="player me">${name} (${score})</div>`);
				else UTILS.$.appendHTML(this.$container, `<div class="player">${name} (${score})</div>`);
			}
		}

		customElements.define('guess-different', App);
		customElements.define('choose-name', ChooseNameComponent);
		customElements.define('players-view', PlayersComponent);
		customElements.define('question-view', QuestionComponent);
	</script>
</body>

</html>