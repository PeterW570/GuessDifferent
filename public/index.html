<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Guess Different</title>
	<style>
		*,
		*::before,
		*::after {
			position: relative;
			box-sizing: border-box;
		}

		html,
		body {
			height: 100%;
			margin: 0;
			background-image: linear-gradient(135deg, #81FBB8 10%, #28C76F 100%);
			font-family: system-ui, Roboto, Arial, sans-serif;
		}

		@keyframes spinner {
			0% {
				transform: translate3d(-50%, -50%, 0) rotate(0deg);
			}

			100% {
				transform: translate3d(-50%, -50%, 0) rotate(360deg);
			}
		}

		.loading>* {
			visibility: hidden
		}

		.loading::after {
			animation: 1.5s linear infinite spinner;
			animation-play-state: inherit;
			border: solid 5px #cfd0d1;
			border-bottom-color: #1c87c9;
			border-radius: 50%;
			content: "";
			height: 40px;
			width: 40px;
			position: absolute;
			top: 10px;
			left: 20px;
			transform: translate3d(-50%, -50%, 0);
			will-change: transform;
		}

		input {
			border: 2px solid black;
			border-radius: 4px;
			padding: 2px;
			background-color: rgba(255, 255, 255, 0.3);
			font-size: 1.5rem;
		}

		button {
			border: 2px solid black;
			border-radius: 4px;
			padding: 2px 6px;
			background-color: rgba(255, 255, 255, 0.8);
			font-size: 1rem;
		}

		.text-center {
			text-align: center;
		}

		.bold {
			font-weight: bold;
		}

		.font-l {
			font-size: 1.2rem;
		}

		.font-xl {
			font-size: 1.5rem;
		}

		guess-different {
			display: grid;
			grid-template-areas: "title""main""players";
			grid-template-rows: auto minmax(0, 1fr) auto;
			height: 100%;
			padding: 8px;
		}

		main {
			margin: 0 auto;
			max-width: 40rem;
			width: 100%;
			padding: 20px;
		}

		.time-left {
			position: absolute;
			right: -20px;
			top: 8px;
			height: 40px;
			width: 40px;
			border-radius: 58% 42% 53% 47% / 42% 52% 48% 58%;
			background-image: linear-gradient(135deg, #FDEB71 10%, #F8D800 100%);
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
			display: flex;
			align-items: center;
			justify-content: center;
			font-variant-numeric: tabular-nums;
		}

		.question-container {
			border-radius: 8px;
			padding: 8px 12px;
			background-color: rgba(255, 255, 255, 0.3);
		}

		.option-pair {
			margin: 8px;
		}

		.option-pair>input {
			margin-right: 6px;
		}

		players-view {
			grid-area: players;
		}

		.players-container {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
			grid-gap: 8px;
		}

		.player {
			border-radius: 50%;
			height: 100px;
			min-width: 50px;
			display: flex;
			align-items: center;
			justify-content: center;
			text-align: center;
			background-image: linear-gradient(135deg, #CE9FFC 10%, #7367F0 100%);
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.07);
			color: white;
		}

		.player.me {
			background-image: linear-gradient(135deg, #8aceff 10%, #0396FF 100%);
		}
	</style>
</head>

<body>
	<guess-different></guess-different>

	<script type="module">
		import UTILS from './scripts/utils.js';
		let playerName = null;

		class BaseView extends HTMLElement {
			showSpinner() {
				UTILS.$.addClass(this, 'loading');
				return {
					hide: () => UTILS.$.removeClass(this, 'loading'),
				}
			}
		}

		class App extends BaseView {
			connectedCallback() {
				this.innerHTML = `
					<h1 class="text-center">Guess Different</h1>
					<main>
						<choose-name class="text-center"></choose-name>
					</main>
					<players-view></players-view>
				`
				const spinner = this.showSpinner();
				UTILS.WS.connect(() => spinner.hide());

				UTILS.WS.addSub(({ message: { question, possibleAnswers } }) => {
					UTILS.$.appendHTML(this.querySelector('main'), `<question-view></question-view>`);
					this.querySelector('question-view').setQuestion({ question, possibleAnswers });
				}, { key: 'new:question' })
			}
		}

		class QuestionComponent extends BaseView {
			setQuestion({ question, possibleAnswers, timeForQuestion = 20 }) {
				this.innerHTML = `
				<div class="question-container">
					<div class="font-l bold">${question}</div>
					<div class="option-container">
						${possibleAnswers.map(ans => `<div class="option-pair"><input type="radio" id="${ans}" name="question" value="${ans}" /><label for="${ans}">${ans}</label></div>`).join('')}
					</div>
					<div class="time-left">-</div>
				</div>
				`

				let secondsRemaining = timeForQuestion;
				const ONE_SECOND = 1000;

				function updateAfterSecond() {
					setTimeout(() => {
						secondsRemaining--;
						if (secondsRemaining > 0) {
							this.querySelector('.time-left').innerHTML = secondsRemaining;
							updateAfterSecond.call(this);
						}
						else {
							const answer = this.querySelector('input[name="question"]:checked')?.value;
							UTILS.WS.send({ key: 'check:answer', message: answer });
							this.remove();
						}
					}, ONE_SECOND);
				}
				this.querySelector('.time-left').innerHTML = secondsRemaining;
				updateAfterSecond.call(this);
			}
		}

		class ChooseNameComponent extends BaseView {
			connectedCallback() {
				this.innerHTML = `<form>
					<input name="name" placeholder="Name" />
					<button type="submit">Submit</button>
				</form>`;
				this.boundOnSubmitForm = this.onSubmitForm.bind(this);
				this.querySelector('form').addEventListener('submit', this.boundOnSubmitForm);
			}

			disconnectedCallback() {
				this.querySelector('form').removeEventListener('submit', this.boundOnSubmitForm);
			}

			onSubmitForm(e) {
				e.preventDefault();
				const name = this.querySelector('input').value;
				const spinner = this.showSpinner();
				UTILS.WS.addSub(({ message }) => {
					if (message !== 'OK') console.error('error setting name'); // TODO: handle
					playerName = name;
					spinner.hide();
					this.remove();
				}, { key: 'set:name', once: true });
				UTILS.WS.send({ key: 'set:name', message: name });
			}
		}

		class PlayersComponent extends BaseView {
			connectedCallback() {
				this.innerHTML = `<div class="players-container"></div>`;
				this.$container = this.querySelector('.players-container');

				UTILS.WS.addSub(({ key, message: allData }) => {
					// TODO: just update rather than empty + add
					UTILS.$.empty(this.$container);
					allData.filter(d => d.name !== 'One Admin').forEach(d => this.addPlayer(d));
				}, { key: 'all-players' });
				UTILS.WS.send({ key: 'get:players' });
			}
			addPlayer({ name = 'Anon', score = 0 }) {
				const borderRadiusStr = `border-radius: ${Math.round(Math.random() * 30 + 35)}% ${Math.round(Math.random() * 30 + 35)}% ${Math.round(Math.random() * 30 + 35)}% ${Math.round(Math.random() * 30 + 35)}% / ${Math.round(Math.random() * 30 + 35)}% ${Math.round(Math.random() * 30 + 35)}% ${Math.round(Math.random() * 30 + 35)}% ${Math.round(Math.random() * 30 + 35)}%;`;
				if (name === playerName) UTILS.$.appendHTML(this.$container, `<div class="player me" style="${borderRadiusStr}">${name} (${score})</div>`);
				else UTILS.$.appendHTML(this.$container, `<div class="player" style="${borderRadiusStr}">${name} (${score})</div>`);
			}
		}

		customElements.define('guess-different', App);
		customElements.define('choose-name', ChooseNameComponent);
		customElements.define('players-view', PlayersComponent);
		customElements.define('question-view', QuestionComponent);
	</script>
</body>

</html>